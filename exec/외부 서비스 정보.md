# 외부서비스.md

본 문서는 프로젝트에서 사용하는 **외부 서비스 가입·설정·연동 방법**을 정리한다.
비밀값은 절대 포함하지 말고, 모든 키는 `.env` 또는 배포 비밀 관리에 주입한다.

---

## 개요 (요약 표)

| 서비스                                | 목적                                   | 어디서 쓰는가                                     | 필요한 권한/Scope                                  | 필수 ENV 키                                                                                            |
| ------------------------------------- | -------------------------------------- | ------------------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| **Google OAuth**                      | 사용자 로그인(프로필/이메일)           | 백엔드 `/auth/google` & `/auth/google/callback`   | `profile email`                                    | `GOOGLE_LOGIN_ENDPOINT`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `REDIRECT_URI`, `CLIENT_BASE_URL` |
| **YouTube Data API v3**               | 내 채널 **Live Stream 목록 조회**      | 백엔드 `/auth/youtube` & `/auth/youtube/callback` | `https://www.googleapis.com/auth/youtube.readonly` | `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `YOUTUBE_REDIRECT_URI`, `CLIENT_BASE_URL`                  |
| **MongoDB Atlas** _(외부 DB 사용 시)_ | 애플리케이션 데이터 저장               | 백엔드 DB 연결                                    | (해당 없음)                                        | `MONGO_HOSTS`, `MONGO_DATABASE_NAME`, `MONGO_REPLICA`, `MONGO_USER`, `MONGO_PASS`, `MONGO_APP_NAME`    |
| **Twilio Network Traversal** _(선택)_ | STUN/TURN(ICE) 제공 → WebRTC 연결 보조 | 스트리밍/웹 클라이언트 ICE 서버                   | (해당 없음)                                        | `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`                                                              |

---

## 1) Google OAuth (로그인)

### 역할

- 사용자를 Google 계정으로 인증 → 사용자 정보 가져오기 → 서버에서 자체 JWT 발급 & 쿠키 저장 → 프론트로 리다이렉트.&#x20;

### 준비 (Google Cloud Console)

1. OAuth 클라이언트 생성 (웹 애플리케이션)
2. **승인된 리디렉트 URI** 추가:
   `https://<도메인>/auth/google/callback` (로컬: `http://localhost:<port>/auth/google/callback`)
3. 클라이언트 ID/SECRET 발급

### 환경 변수

```
GOOGLE_LOGIN_ENDPOINT=https://accounts.google.com/o/oauth2/v2/auth
GOOGLE_CLIENT_ID=__FILL_ME__
GOOGLE_CLIENT_SECRET=__FILL_ME__
REDIRECT_URI=https://<도메인>/auth/google/callback
CLIENT_BASE_URL=https://<프론트도메인>
```

(백엔드 라우터는 위 키들을 사용해 Authorization Code Flow 수행 후, `token` 쿠키 발급 및 `${CLIENT_BASE_URL}/oauth/callback?is_new_user=…`로 리다이렉트한다.)&#x20;

### 주의/권장

- 운영에서는 쿠키 옵션에 `secure:true` 권장(HTTPS 전제).&#x20;
- 장기 사용이 필요하면 `access_type=offline`로 리프레시 토큰 발급 고려(현재 코드는 `online`).&#x20;
- **state 파라미터**로 CSRF 방지 권장.

---

## 2) YouTube Data API (Live Streams 조회)

### 역할

- Google OAuth로 사용자 승인 후 **내 채널 스트림 목록**(`liveStreams.list`) 조회 → 팝업 창에서 부모 창으로 목록 전달.&#x20;

### 준비 (Google Cloud Console)

1. **YouTube Data API v3** 사용 설정
2. OAuth 클라이언트 생성 & **Redirect URI** 등록:
   `https://<도메인>/auth/youtube/callback`

### 권한/Scope

```
https://www.googleapis.com/auth/youtube.readonly
```

(코드 상 동일 스코프 사용.)&#x20;

### 환경 변수

```
GOOGLE_CLIENT_ID=__FILL_ME__
GOOGLE_CLIENT_SECRET=__FILL_ME__
YOUTUBE_REDIRECT_URI=https://<도메인>/auth/youtube/callback
CLIENT_BASE_URL=https://<프론트도메인>
```

### 동작 요약

- `/auth/youtube` → Google 동의 화면으로 리다이렉트
- `/auth/youtube/callback` → 토큰 교환 →
  `GET https://www.googleapis.com/youtube/v3/liveStreams?part=id,snippet,cdn,status&mine=true` 호출 →
  `window.opener.postMessage({ type:'YOUTUBE_STREAM_LIST', data: [...] }, CLIENT_BASE_URL)` 후 팝업 종료.&#x20;

### 주의/권장

- 오리진 안전을 위해 `postMessage`의 대상 오리진은 \*\*정확한 `CLIENT_BASE_URL`\*\*로 고정.&#x20;
- 장기 사용 시 `access_type=offline` 고려(현재 `online`).&#x20;

---

## 3) MongoDB Atlas (외부 DB)

### 역할

- 애플리케이션 데이터 저장. 백엔드는 **ReplicaSet + TLS** 옵션의 커넥션 문자열을 사용한다.&#x20;

### 환경 변수

```
MONGO_HOSTS=host1:27017,host2:27017,host3:27017
MONGO_DATABASE_NAME=nimf_db
MONGO_REPLICA=atlas-<replica-name>
MONGO_USER=__FILL_ME__
MONGO_PASS=__FILL_ME__
MONGO_APP_NAME=nimf
```

(코드는 `mongodb://<hosts>/<db>?ssl=true&replicaSet=<replica>&authSource=admin&retryWrites=true&w=majority` 형태로 접속한다.)&#x20;

### 설정 체크

- Atlas **IP Allowlist**에 서버/Runner IP 등록
- 사용자/권한(Role) 발급
- 복원: `mongorestore --archive=dump_YYYYMMDD.archive --nsInclude=<DB>.*`

---

## 4) Twilio Network Traversal (STUN/TURN) — _선택_

### 언제 필요한가

- 공인망/대칭 NAT/방화벽 환경에서 WebRTC 연결 실패가 발생하는 경우. TURN 릴레이가 필요하다.

### 준비

1. Twilio 가입 → **Network Traversal** 활성화
2. 서버에서 Twilio API로 \*\*ICE 서버 구성(credential 포함)\*\*을 받아 클라이언트에 전달
3. 클라이언트/스트리밍의 `RTCPeerConnection({ iceServers })`에 주입

### 환경 변수

```
TWILIO_ACCOUNT_SID=__FILL_ME__
TWILIO_AUTH_TOKEN=__FILL_ME__
```

### 비용/보안 메모

- TURN 트래픽은 과금되므로 운영에서 모니터링 필요
- 전 구간 TLS, 쿠키 `secure` 권장

---

## 5) CI/CD (Jenkins) — _선택 문서화 항목_

- Jenkins에서 배포 시 필요한 **환경 변수/시크릿 목록**과 주입 방법을 기록(예: Credentials 바인딩, `.env` 템플릿 채우는 스텝).
- 빌드 아티팩트(프론트 `dist/`), 이미지 태그 규칙, 배포 파이프라인 단계(빌드→테스트→배포→헬스체크).

---
